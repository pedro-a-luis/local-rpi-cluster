# Pi-hole SSH Configuration - Completed

**Date**: October 26, 2025
**Status**: ✅ Completed

---

## Summary

SSH access to Pi-hole servers has been successfully configured using a unified SSH key pair.

### Pi-hole Servers

| Server | Hostname | IP | Status | OS Updates Available |
|--------|----------|-----|--------|---------------------|
| Primary | rpi-vpn-1 | 192.168.1.25 | ✅ Connected | 19 packages |
| Secondary | rpi-vpn-2 | 192.168.1.26 | ✅ Connected | 102 packages |

---

## Configuration Details

### SSH Key

- **Location**: `~/.ssh/pihole` (private key), `~/.ssh/pihole.pub` (public key)
- **Type**: RSA 4096-bit
- **Comment**: pihole-admin
- **Purpose**: Access to both Pi-hole servers from this workstation

### SSH Config

The following configuration was added to `~/.ssh/config`:

```ssh
# Pi-hole DNS Servers (Raspberry Pi 3)
Host rpi-vpn-1 192.168.1.25
    HostName 192.168.1.25
    User admin
    IdentityFile ~/.ssh/pihole
    StrictHostKeyChecking no

Host rpi-vpn-2 192.168.1.26
    HostName 192.168.1.26
    User admin
    IdentityFile ~/.ssh/pihole
    StrictHostKeyChecking no
```

### Ansible Inventory

Updated [ansible/inventory/hosts.yml](ansible/inventory/hosts.yml) with:

```yaml
pihole:
  hosts:
    rpi-vpn-1:
      ansible_host: 192.168.1.25
      pihole_role: primary
      wireguard_enabled: true
    rpi-vpn-2:
      ansible_host: 192.168.1.26
      pihole_role: secondary
      wireguard_enabled: true
  vars:
    ansible_user: admin
    ansible_ssh_private_key_file: ~/.ssh/pihole
    ansible_python_interpreter: /usr/bin/python3
```

---

## Access Methods

### Direct SSH

```bash
# Primary Pi-hole
ssh rpi-vpn-1
# or
ssh admin@192.168.1.25

# Secondary Pi-hole
ssh rpi-vpn-2
# or
ssh admin@192.168.1.26
```

### Ansible

```bash
# Test connectivity
ansible pihole -m ping

# Run commands
ansible pihole -m shell -a "pihole status"

# Run playbooks
ansible-playbook ansible/playbooks/infrastructure/update-pihole.yml
```

### Update Script

```bash
# Check status
./scripts/update-pihole.sh --status

# Update both servers
./scripts/update-pihole.sh

# Update specific server
./scripts/update-pihole.sh --primary
./scripts/update-pihole.sh --secondary
```

---

## Verification Tests

All tests passed:

✅ SSH connectivity to rpi-vpn-1 (192.168.1.25)
✅ SSH connectivity to rpi-vpn-2 (192.168.1.26)
✅ Ansible ping to both servers
✅ Pi-hole status check via update script
✅ DNS resolution test (grafana.stratdata.org → 192.168.1.240)

---

## Current Pi-hole Status

### Primary (rpi-vpn-1)
- FTL version: v6.3 (Latest)
- Status: Active and blocking
- OS updates available: 19 packages
- DNS service: ✓ Listening on all protocols

### Secondary (rpi-vpn-2)
- FTL version: v6.2.3 (Update to v6.3 available)
- Status: Active and blocking
- OS updates available: 102 packages
- DNS service: ✓ Listening on all protocols

---

## Next Steps

### Recommended Actions

1. **Update Pi-hole Servers** (102 packages on secondary, 19 on primary)
   ```bash
   ./scripts/update-pihole.sh --secondary  # Update secondary first (safer)
   ./scripts/update-pihole.sh --primary    # Then update primary
   ```

2. **Verify Updates**
   ```bash
   ./scripts/update-pihole.sh --status
   ```

3. **Test DNS Resolution**
   ```bash
   nslookup grafana.stratdata.org 192.168.1.25
   nslookup grafana.stratdata.org 192.168.1.26
   ```

---

## Security Notes

### What Was Done

1. ✅ Created new dedicated SSH key pair (`~/.ssh/pihole`)
2. ✅ Deployed public key to both Pi-hole servers
3. ✅ Removed temporary gravity-sync keys from workstation
4. ✅ Deleted `/root/gitlab/local-rpi-cluster/ssh-to-delete/` folder
5. ✅ Configured SSH config for easy access
6. ✅ Updated Ansible inventory with key location

### Key Management

- **Private Key**: `/root/.ssh/pihole` (permissions: 600)
- **Public Key**: `/root/.ssh/pihole.pub` (permissions: 644)
- **Authorized on**: Both rpi-vpn-1 and rpi-vpn-2 at `/home/admin/.ssh/authorized_keys`

⚠️ **Important**: The private key (`~/.ssh/pihole`) should be backed up securely and never committed to Git.

### Gravity Sync

The gravity-sync SSH keys generated by the setup-gravity-sync.yml playbook remain on the Pi-hole servers themselves at `/home/admin/.ssh/id_rsa` for inter-server synchronization. These are separate from the workstation access key.

---

## Troubleshooting

### SSH Connection Issues

If SSH fails:

```bash
# Test connectivity
ping 192.168.1.25
ping 192.168.1.26

# Test with verbose output
ssh -v -i ~/.ssh/pihole admin@192.168.1.25

# Check key permissions
ls -la ~/.ssh/pihole*
# Should show: -rw------- for private key, -rw-r--r-- for public key
```

### Ansible Connection Issues

```bash
# Test with verbose output
ansible pihole -m ping -vvv

# Verify inventory
ansible-inventory --list -i ansible/inventory/hosts.yml
```

---

## Related Documentation

- [Pi-hole Update Guide](ansible/playbooks/infrastructure/PIHOLE-UPDATE-GUIDE.md)
- [Pi-hole Maintenance Guide](docs/operations/pihole-maintenance.md)
- [Update Script](scripts/update-pihole.sh)
- [Ansible Inventory](ansible/inventory/hosts.yml)

---

**Configuration completed successfully on October 26, 2025**
